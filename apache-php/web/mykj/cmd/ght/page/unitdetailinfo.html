<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title></title>
<script src="../js/boot.js" type="text/javascript"></script>
</head>
<body>
<div class="mini-toolbar" borderStyle="border:0px;" style="background:none;margin-top:5px;margin-bottom:5px;">
</div>
   <div class="mini-fit">
   <div  style="height:98%;width:98%;padding-left:10px;">
        <div id="datagrid1" class="mini-datagrid" style="width:100%;height:16%" 
        url="../unitInfoAction.do?method=getPageData" idField="tid" selectOnLoad="true" onselectionchanged="onSelectionChanged"  allowMoveColumn=false pageSize="100" showPager=false showReloadButton=false >
           <div property="columns">
              <div type="indexcolumn" headerAlign="center"  align="center">序号</div>
              <div field="tid" width="120" headerAlign="center" allowSort="true" visible=false>tid</div>
              <div field="judeid" width="120" headerAlign="center" allowSort="true" visible=false>judeid</div>
              <div allowSort="true" field="unitname" width="100" headerAlign="center" align="center">单位名称</div>   
              <div allowSort="true" field="unitinfo" width="180"  headerAlign="center" align="center">工会简介</div> 
              <div allowSort="true" field="address" width="120" headerAlign="center" align="center">单位地址</div>
              <div allowSort="true" field="contacts" width="80" headerAlign="center" align="center">法人代表</div>
              <div allowSort="true" field="cghzx" width="80" headerAlign="center" align="center">工会主席</div>
              <div allowSort="true" field="cphone" width="100" headerAlign="center" align="center">联系电话</div>
              <div allowSort="true" field="cindustry" width="80" headerAlign="center" align="center">所属行业</div>
             <div allowSort="true" field="remark" width="100" headerAlign="center" align="center">备注</div>
              <div name="action" width="80" headerAlign="center" align="center" renderer="onActionRenderer" cellStyle="padding:0;">操作</div>             
           </div>
        </div>
        <div  class="mini-toolbar" borderStyle="border:0px;" style="background:none;margin-top:12px;margin-bottom:10px;" >
            <span>工会工作人员：</span><input type="text" class="mini-textbox" id="key" style="margin-right:10px;">    
            <a class="mini-button" iconCls="icon-search" onclick="search(2)" style="margin-left:10px;margin-right:20px;">查找</a>
            <a class="mini-button" iconCls="icon-add" onclick="public_openWindow2" id="addData2" style="margin-right:20px;">添加工会人员</a>
            <a class="mini-button" iconCls="icon-download" id="ExportExcel" onclick="ExcelPayData()" style="margin-right:20px;">导出</a>
         </div>
     <div id="datagrid2" class="mini-datagrid" style="width:100%;height:72%" 
	    url="../unitorganInfoAction.do?method=getPageData" idField="tid" selectOnLoad="true"  allowMoveColumn=false pageSize="50" load="setPage()" showPager="false" showReloadButton=false >
             <div property="columns">
                <div type="indexcolumn" headerAlign="center">序号</div>
                <div field="tid" width="120" headerAlign="center" visible=false>tid</div>
                <div field="unitid" width="120" headerAlign="center" visible=false>unitid</div>
                <div allowSort="true" field="username" width="80" headerAlign="center"  align="center">姓名</div>
                <div allowSort="true" field="upost" width="80" align="center" headerAlign="center">职务</div>
                <div allowSort="true" field="uphone" width="80" headerAlign="center" align="center">联系电话</div>
                <div allowSort="true" field="udepartment" width="80" headerAlign="center" align="center">所属部门</div>
                <div allowSort="true" field="uduty" width="180" headerAlign="center" align="center">工作职责</div>
                <div allowSort="true" field="uremark" width="100"  headerAlign="center" align="center">备注</div>
               <div name="action" width="80" headerAlign="center" align="center" renderer="onActionRenderer2" cellStyle="padding:0;">操作</div>
              </div>
     </div>
  </div>
</div>
<div id="editWindow" class="mini-window" title="添加单位信息" style="width:360px;height:430px;"  showModal="true" allowResize="true" allowDrag="true">
    <div id="editform" class="form" >
        <input class="mini-hidden" name="tid" id="tid"/>
        <table style="width:100%;">
            <tr height="36">
             	<td style="width:72px;" align="center">单位名称</td>
                <td align="center"><input style="width:180px;" name="unitname" class="mini-textbox" required="true" /></td>
            </tr>
            <tr height="36">
                <td style="width:72px;" align="center">单位地址</td>
                <td align="center"><input style="width:180px;"  name="address" required="true" class="mini-textbox" /></td>
            </tr>
            <tr height="50">
                <td style="width:72px;" align="center">工会简介</td>
                <td align="center"><input style="width:180px;"  name="unitinfo" required="true" class="mini-TextArea" /></td>
            </tr>
            <tr height="36">
               <td style="width:72px;" align="center">法人代表</td>
                <td align="center"><input style="width:180px;" name="contacts" required="true" class="mini-textbox" /> </td>
            </tr>
             <tr height="36">
               <td style="width:72px;" align="center">工会主席</td>
                <td align="center"><input style="width:180px;" name="cghzx" required="true" class="mini-textbox" /> </td>
            </tr>
            <tr height="36">
               <td style="width:72px;" align="center">联系电话</td>
                <td align="center"><input style="width:180px;" name="cphone" required="true" class="mini-textbox" /> </td>
            </tr>
            <tr height="36">
               <td style="width:72px;" align="center">所属行业</td>
                <td align="center"><input style="width:180px;" name="cindustry" required="true" class="mini-textbox" /> </td>
            </tr>
            <tr height="36">
            	<td style="width:72px;" align="center">备注：</td>
                <td align="center">    
                     <input name="remark" class="mini-TextArea" style="width:180px;" />
                </td>
            </tr>
            <tr height="48" id="editWindowButton">
                <td align="center" colspan="6">
                    <a class="mini-button" style="width:60px;margin-right:20px;" href="javascript:onOk()">确定</a> &nbsp;&nbsp;&nbsp;
                    <a class="mini-button" style="width:60px;" href="javascript:cancelRow()">取消</a>
                </td>                
            </tr>
        </table>
    </div>
</div>
<div id="editWindow2" class="mini-window" title="添加工会工作人员" style="width:350px;height:380px;" 
    showModal="true" allowResize="true" allowDrag="true">
    <div id="editform2" class="form" >
       <input class="mini-hidden" name="tid" id="tid"/>
       <table style="width:100%;">
            <tr height="36">
             	<td style="width:72px;" align="center">姓名</td>
                <td align="center"><input style="width:240px;" name="username" class="mini-textbox" required="true" /></td>
            </tr>
            <tr height="36">
                <td style="width:72px;" align="center">职务</td>
                <td align="center"><input style="width:240px;"  name="upost" class="mini-textbox" required="true" /></td>
            </tr>
            <tr height="36">
                <td style="width:72px;" align="center">电话</td>
                <td align="center"><input style="width:240px;"  name="uphone" class="mini-textbox" required="true" /></td>
            </tr>
            <tr height="36">
                <td style="width:72px;" align="center">所属部门</td>
                <td align="center"><input style="width:240px;"  name="udepartment" class="mini-textbox" required="true" /></td>
            </tr>
            <tr height="56">
               <td style="width:72px;" align="center">职责</td>
               <td align="center">    
                     <input name="uduty" class="mini-TextArea" style="width:240px;" />
                </td>
            </tr>
            <tr height="56">
            	<td style="width:72px;" align="center">备注：</td>
                <td align="center">    
                     <input name="uremark" class="mini-TextArea" style="width:240px;" />
                </td>
            </tr>
            <tr height="48" id="editWindowButton1">
                <td align="center" colspan="6">
                    <a class="mini-button" style="width:60px;margin-right:20px;" href="javascript:onOk(2)"> 确定</a> &nbsp;&nbsp;&nbsp;
                    <a class="mini-button" style="width:60px;" href="javascript:cancelRow2()">取消</a>
                </td>                
            </tr>
        </table>
    </div>
</div>
<iframe id="exportIFrame" style="display:none;" url="" ></iframe>
    <!--导出Excel相关HTML-->
     <form id="excelForm"  action="export.jsp?type=excel" method="post" target="excelIFrame">
        <input type="hidden" name="columns" id="excelData" />
        <input type="hidden" name="code" id="code" />
    </form>
<iframe id="excelIFrame" name="excelIFrame" style="display:none;"></iframe> 
<script>
var gdeid=0;
mini.parse();
var grid = mini.get("datagrid1"), Dtree = mini.get("tree1"),grid2 = mini.get("datagrid2"), editWindow2 = mini.get("editWindow2"),form2 = new mini.Form("#editform2");
var editWindow = mini.get("editWindow");
var form = new mini.Form("#editform");
grid.sortBy("tid", "desc");

function onOk(e) {
	if( typeof e !="undefined" && e == 2 ){
		SaveData("../unitorganInfoAction.do?method=savedetail", 2 );
	}else{
		SaveData("../unitInfoAction.do?method=save" , 1 );
	}
}
function SaveData(url,type) {
	if( type == 1 ){
		 var  gridObj = grid, formObj = form,editWindowObj = editWindow ;
	}else{
		 var  gridObj = grid2,formObj = form2,editWindowObj = editWindow2;
	}
	var o = formObj.getData();            
	formObj.validate();
	if (formObj.isValid() == false) return;
	gridObj.loading("保存中，请稍后......");
	var json = mini.encode([o]);
	$.ajax({
		url: url,
		type: 'post',
		data: { data: json },
		cache: false,
		success: function (text) {
			gridObj.reload();
			if(type == 1){
			   mini.get("tree1").reload();
			}
		}
	});
	editWindowObj.hide();
}

function open_add_window(){
	public_openWindow();
}
	
function editRow(url,type){
	if(type == 1){
	    var  editWindowObj = editWindow , formObj = form ;
	}else{
	    var  editWindowObj = editWindow2,formObj = form2;
	}
	if (url){
		 editWindowObj.setTitle(editWindowObj.getTitle().replace("添加","修改"));
		 editWindowObj.show();
	     formObj.clear();
		 formObj.loading();
		 $.ajax({
			url:url,
			success: function (text) {
				formObj.unmask();
				var o = mini.decode(text);
				formObj.setData(o);
			}
		});
	}
}

function delRow(url,type) {
	if(type == 1 ){
		var gridObjc = grid;
    }else{
		var gridObjc = grid2;
	}
	if (url){
		if (confirm("确定删除此记录？")) {
			gridObjc.loading("删除中，请稍后......");
			$.ajax({
				url: url,
				success: function (text) {
				   gridObjc.reload();
				   if(type == 1){
			         mini.get("tree1").reload();
			       }
				},
				error:function(){
				}
			});
		}
	}
}

function cancelRow2() {
  grid2.reload();
  editWindow2.hide();
}

function onActionRenderer(e) {
	var record = e.record;
	var uid = record.tid;
	var pid = record.judeid
	var s = '';
       
    if(pid != '0'){
       	s = '<a class="Edit_Button" href="javascript:editRow(\'../unitInfoAction.do?method=detailJson&id=' + uid + '\',1)">修改</a>'
			+ '<a class="Delete_Button" href="javascript:delRow(\'../unitInfoAction.do?method=delete&id=' + uid + '\',1)">删除</a>';
     }else{
        s = '<a class="Edit_Button" href="javascript:editRow(\'../unitInfoAction.do?method=detailJson&id=' + uid + '\',1)">修改</a>';
     }
	return s;
}
function onActionRenderer2(e) {
	var grid2 = e.sender;
	var record = e.record;
	var uid = record.tid;

	var s = '<a class="Edit_Button" href="javascript:editRow(\'../unitorganInfoAction.do?method=detailJson&id=' + uid + '\',2)">修改</a>'
		  + '<a class="Delete_Button" href="javascript:delRow(\'../unitorganInfoAction.do?method=delete&id=' + uid + '\',2)">删除</a>';
	return s;
}
function onDrawNode(e) {
	var tree = e.sender;
	var node = e.node;
	var isLeaf = tree.isLeaf(node);
	//所有子节点加上超链接
	if (isLeaf == true) {
	  //e.nodeHtml = '<a href="http://www.miniui.com/docs/api/' + node.id + '.html" target="_blank">' + node.text + '</a>';
	}
	//父节点高亮显示；子节点斜线、蓝色、下划线显示
	if (isLeaf == false) {
		e.nodeStyle = 'font-weight:bold;';
	} else {
	}
	//修改默认的父子节点图标
	if (isLeaf == false) {
		e.iconCls = "dang";
	}else{
		  if(typeof(node.children)!='undefined'){
			 e.iconCls = "dang";
		  }else{
			 e.iconCls = "dang2";
		  }
	}
	//父节点的CheckBox全部隐藏
	if (isLeaf == false) {
		e.showCheckBox = false;
	}
}

function beforenodeselect(e) {
	var tree = e.sender;
	var node = e.node;
	//禁止选中父节点
	if (e.isLeaf == false){
		 e.cancel = true;
	}
}

function public_openWindow2(){
	form2.clear();
	var title = $("#editWindowTitle2").val();
	if(title){
		editWindow2.setTitle(title);
	}
	editWindow2.setTitle(editWindow2.getTitle().replace("修改","添加"));
	editWindow2.show();
}	

function onSelectionChanged(e) {
	var grid = e.sender;
	var record = grid.getSelected();
	var tid;
	if (record) {
	    tid=record.tid;
	    gdeid=record.tid;
		grid2.load({deid:tid,key:''});
	}
 }
 
function ExcelPayData(){
    var titlestr = mini.get("key").getValue();
    if (gdeid!=0){
      	var excelForm = document.getElementById("excelForm");
            excelForm.action = "../unitorganInfoAction.do?method=getPageDataExcel&key="+titlestr+"&deid="+gdeid;
	        excelForm.submit(); 
	}
 }
   
function search(type){	
	var gridObj;	
	if(typeof type !== "undefined" && type == 2 ){
		gridObj = grid2;
		var skey="";
		var keyobj = mini.get("key");
		if (typeof keyobj!="undefined" ){
		   skey = keyobj.getValue();
		}
		var record = grid.getSelected();
		if (record){
			gridObj.load({deid:gdeid,key:skey});
		}
	}
}
</script>
</body>
</html>
